import app from './app';
import { initDB } from './models';
import dotenv from 'dotenv';

// ==================================================================
// 1. ç¯å¢ƒé…ç½®åŠ è½½
// ==================================================================
// åŠ è½½ .env æ–‡ä»¶ä¸­çš„ç¯å¢ƒå˜é‡
// åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹åˆ›å»º .env æ–‡ä»¶ï¼Œå¯ä»¥é…ç½® PORT, JWT_SECRET ç­‰æ•æ„Ÿä¿¡æ¯
dotenv.config();

// è®¾ç½®æœåŠ¡å™¨ç›‘å¬ç«¯å£ï¼Œé»˜è®¤ä¸º 3000
const PORT = process.env.PORT || 3000;

// ==================================================================
// 2. æœåŠ¡å™¨å¯åŠ¨æµç¨‹
// ==================================================================
const startServer = async () => {
  try {
    console.log('Starting server...');

    // ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–æ•°æ®åº“
    // è¿æ¥ SQLite æ•°æ®åº“ï¼Œå¹¶æ ¹æ® Model å®šä¹‰è‡ªåŠ¨åˆ›å»º/æ›´æ–°æ•°æ®è¡¨
    await initDB();
    console.log('Database initialized successfully.');
    
    // ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ HTTP æœåŠ¡å™¨
    // app.listen å¼€å¯ç«¯å£ç›‘å¬ï¼Œå¼€å§‹æ¥æ”¶ HTTP è¯·æ±‚
    app.listen(PORT, () => {
      console.log(`
      ################################################
      ğŸ›¡ï¸  Server listening on port: ${PORT} ğŸ›¡ï¸
      http://localhost:${PORT}
      ################################################
      `);
    });

  } catch (error) {
    // å¦‚æœå¯åŠ¨è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ (å¦‚æ•°æ®åº“è¿æ¥å¤±è´¥)ï¼Œæ‰“å°é”™è¯¯å¹¶é€€å‡ºè¿›ç¨‹
    console.error('Failed to start server:', error);
    process.exit(1); // é 0 çŠ¶æ€ç è¡¨ç¤ºå¼‚å¸¸é€€å‡º
  }
};

// æ‰§è¡Œå¯åŠ¨å‡½æ•°
startServer();
